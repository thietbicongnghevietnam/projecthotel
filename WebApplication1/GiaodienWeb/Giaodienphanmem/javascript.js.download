//24/2/2016 height popup
function updateCatg() {
    var windowWidth = jQuery(window).width();
    var wH = jQuery(window).height();

    if (windowWidth > 767) {
        jQuery('.box-tribute-home').show();
        jQuery(".register-wrapper,.off-canvas-inner-pr ul.navbar-nav").removeAttr("style");
    } else {
        var rh = 50;
        //if (windowWidth <= 480) rh = 40;
        $(".register-wrapper,.off-canvas-inner-pr ul.navbar-nav").css("max-height", wH - rh);
    }
    $('.navbar-toggle').click(function () {
        if ($("body").hasClass('mnopen')) {
            //$("body").css('overflow','hidden');
            $("body").removeAttr('style');
        } else {
            $("body").css('overflow', 'hidden');
            //$("body").removeAttr('style');
        }
    });
}

function updateListLeft() {
    var windowWidth = jQuery(window).width();
    var wH = jQuery(window).height();

    if (windowWidth > 768) {
        jQuery(".page-support-detail .col-left .col-left-support").removeAttr("style");
    } else {
        jQuery(".page-support-detail .col-left .col-left-support").css("max-height");
    }
}

//end 24/2/2016

function scrollTo($a, $b) {
    windowWidth = jQuery(window).width();
    if (windowWidth <= 1024) $('html, body').animate({scrollTop: $a}, $b);
}

$(function () {
    $('body').on('click', function (e) {
        if ((e.target.className != "menusub") && (e.target.className != "menusub tab"))
            $(".navbar-kiotviet .nav-kiotviet li ul").removeClass('activesub');
    });

    $(".navbar-kiotviet .nav-kiotviet li ul li a").click(function () {
        $(this).parent().parent().removeClass('activesub').hide();
    });
    $(".navbar-kiotviet .nav-kiotviet .ht").hover(function () {
        $(this).find("ul").removeAttr("style");
    });

    var windowpath = window.location.pathname;
    windowpath = window.location.protocol + "//" + window.location.host + windowpath;

    $('.navbar-bt ul li a').each(function () {
        var navPath = $(this).attr('href');
        if (navPath.toLowerCase() == windowpath.toLowerCase()) {
            $(this).parent().addClass('active');
        }
    });

    $('.select2').select2({
        placeholder: '',
        matcher: function (term, text) {
            var newText = kvUtil.toAscii(text);
            var newTerm = kvUtil.toAscii(term);
            return ('' + newText).toUpperCase().indexOf(('' + newTerm).toUpperCase()) >= 0;
        },
        formatNoMatches: function () {
            return 'Không tìm thấy dữ liệu';
        },
        sortResults: function (results, container, query) {
            var sortedResult = [];
            var provinceResult = [];
            var districtResult = [];
            var matched = [];
            if (query.term != "") {
                for (var i = 0; i < results.length; i++) {
                    var resultItem = results[i];
                    var province = resultItem.text.split('-');
                    var district = province[1].trim();
                    province = province[0].trim();

                    // Search in province
                    var newText = kvUtil.toAscii(province);
                    var newTerm = kvUtil.toAscii(query.term);
                    if (('' + newText).toUpperCase().indexOf(('' + newTerm).toUpperCase()) >= 0) {
                        provinceResult.push(resultItem);
                    } else {
                        //Search in district
                        newText = kvUtil.toAscii(district);
                        if (('' + newText).toUpperCase().indexOf(('' + newTerm).toUpperCase()) >= 0) {
                            districtResult.push(resultItem);
                        }
                    }

                    sortedResult = provinceResult.concat(districtResult);
                }
            } else {
                sortedResult = results;
            }
            sortedResult = sortedResult.splice(0, 40);
            return sortedResult;
        }
    });

    // Close select2 when click outside
    $(document).on("click", function (e) {
        var el = $(e.target);
        if (el.parents("#s2id_location").length == 0) {
            $("#location").select2("close");
        }
    });

    $('.functions ul li a').each(function () {
        var funPath = $(this).attr('href');
        if (funPath == windowpath) {
            $(this).addClass('active');
        }
    });
    $('.dong-nai .fa-minus').click(function () {
        $('.img-1').show();
        $('.img-2').hide();
    });
    $('.img-1').click(function () {
        $(this).hide();
        $('.img-2').show();
    });

    $('.navbar-toggle').click(function () {
        if ($("body").hasClass('mnopen')) {
            $("body").css('overflow', 'hidden');
        }
    });
    $('.bullet-down').click(function () {
        scrollTo($(".sub-content.white-bg").offset().top, 0);
    });

    $('.blog-paging a:first-child').addClass('active');
    $('.blog-paging a').each(function () {
        var navPath = $(this).attr('href');
        if (navPath.toLowerCase() == windowpath.toLowerCase()) {
            $(this).addClass('active');
            $('.blog-paging a:first-child').removeClass('active');
        }
    });

    $("img#captcha-refresh").click(function () {
        change_captcha();
    });

    $(".box-video-support .video").click(function () {
        $(this).find('.img').hide();
        $(".box-video-support .video .play-video").show();
    });

    // support
    $('.support-online-left .support-items h3').click(function () {
        $(this).toggleClass('active');
        $(this).parent().find("ul").slideToggle();
    });
    $('.support-online-left ul li a').each(function () {
        var navPath = $(this).attr('href');
        if (navPath.toLowerCase() == windowpath.toLowerCase()) {
            $(this).addClass('active');
        }
    });
    $('.support-online-left ul li a').each(function () {
        if ($(this).hasClass('active')) {
            $(this).parent().parent().show();
            $(this).parent().parent().parent().find("h3").addClass("active");
        }
    });
    $('.priceOther > a').click(function () {
        $('.priceOther ul').toggle();
        $(this).find('i.add').toggle();
        $(this).find('i.plus').toggle();
    });

    // faqs
    faq = 1;
    $('.faqs-item a.link').click(function () {
        $('.faqs-item ul li aside').removeClass('active').hide();
        $('.faqs-item ul li a.link').removeClass('active');
        $(this).parent().parent().find("aside").toggle().addClass('active');
        $(this).addClass('active');
    });
    $('.list-support li a').click(function () {
        $('.list-support li .help-txt').removeClass('active').hide();
        $('.list-support li a').removeClass('active');
        $(this).parent().find(".help-txt").show();
        $(this).addClass('active');
    });
    $('.faqs-more').click(function () {
        if (faq == 1) {
            $('.faqs-item ul.faqs-show').show();
            $(this).html("Thu nhỏ");
        }
        else {
            $('.faqs-item ul.faqs-show').hide();
            $(this).html("Xem thêm");
        }
        faq = -faq;
    });

    //wiki
    $('.wiki-left ul li a').each(function () {
        var navPath = $(this).attr('href');
        if (navPath.toLowerCase() == windowpath.toLowerCase()) {
            $(this).addClass('active');
        }
    });

    var wiki = 1;
    $('.mobileCatg').click(function () {
        if (wiki == 1) {
            $('.wiki-left').css("width", 265).css("padding", "10px 0 30px 15px").css("overflow", "visible");
            wiki = -wiki;
        }
        else {
            $('.wiki-left').removeAttr("style");
            wiki = -wiki;
        }
    });

    $('.close').click(function () {
        $('.popup').remove();
        $(this).remove();
    });

    $('.mobile-nav').click(function () {
        $('.main-menu').toggle();
        //alert('s');
    });

    $('h3.title-right a').click(function () {
        $('h3.title-right a').removeClass('active');
        $(this).addClass('active');
    });
    $('h3.title-right a.viewmaxBtn').click(function () {
        $('.viewmax').show();
        $('.viewnew').hide();
    });
    $('h3.title-right a.viewnewBtn').click(function () {
        $('.viewmax').hide();
        $('.viewnew').show();
    });

    $('.blog-nav li a').each(function () {
        $(this).html('<span>' + $(this).html() + '</span>');
    });

    $('.kv-login').click(function () {
        var kvnm = $("input.kvnm").val();
        if (kvnm) {
            window.location = "http://" + kvnm + ".kiotviet.vn/";
        }

    });


    updateCatg();
    jQuery(window).resize(function () {
        updateCatg();
    });

    updateListLeft();
    jQuery(window).resize(function () {
        updateListLeft();
    });

    $('.pop-close').click(function () {
        $(".box-tribute-home").hide();
    });

//Bich edit06/07/2015
    $(".leftTitle").click(function () {
        $(this).parents(".support-items").find(".boxLeftC").slideToggle("slow").toggleClass('active');
        if ($(".boxLeftC").hasClass('active')) {
            $(this).parents(".support-items").find(".fa").removeClass('fa-chevron-circle-down').addClass('fa-chevron-circle-up');
        }
        else {
            $(this).parents(".support-items").find(".fa").removeClass('fa-chevron-circle-up').addClass('fa-chevron-circle-down');
        }
    });

    $('.btn.register').click(function () {
        scrollTo(0, 100);
    });


    $(".ht").click(function () {
        $(".fa").removeClass('fa-sort-asc').addClass('fa-sort-desc');
        $(this).find("ul").toggleClass('activesub');
        if ($(this).find("ul").hasClass('activesub')) {
            //$(this).find("ul").show();
            $('.navbar-nav .menu2').removeClass('activesub');
            $(this).find("ul").addClass('activesub');
            $(this).find(".fa").removeClass('fa-sort-desc').addClass('fa-sort-asc');
        }
        else {
            $(this).find("ul").removeClass('activesub');
            $(this).find(".fa").removeClass('fa-sort-asc').addClass('fa-sort-desc');
        }
    });

    $(".menu3").click(function () {
        $(this).parents(".wiki-left").find(".content-menu3").slideToggle("slow").toggleClass('active');
    });
//Bich 22/07/2015
    $('.wiki-left ul li a').each(function () {
        if ($(this).hasClass('active')) {
            $(this).parent().parent().show();
            $(this).parent().parent().parent().find("ul").addClass("active");
        }
    });
    //Bich esit 17/08/2015
    $('#fa-times-circle').click(function () {
        $('.bg-popup').css('display', 'none');
    });

    $('.bg-popup').click(function () {
        $('.bg-popup').css('display', 'none');
    });
    //Bich edit 29/12/2015
    $('.register_close').click(function () {
        $('.register_box, .login_overlay').hide();
        $("html").removeClass("popup-html");
    });
    $('.box-popup-register').click(function () {
        $('body').attr('call-to-action', 'false');
        var $this = $(this);
        $('.register_box, .login_overlay').show();
        if ($this.data('scrolltop') != "no") {
            $("html").addClass("popup-html");
        }
        //scrollTo(0, 200);
    });
    $('.icon-video').click(function () {
        $('.box-video, .login_overlay').show();
        $('.box-video iframe').attr("src", $(this).attr("data-youtube"));
    });
    $('.icon-video.icon-video-ipad').click(function () {
        $('.box-video, .login_overlay').hide();
    });
    $('.register_close').click(function () {
        $('.box-video iframe').attr("src", "");
        $('.box-video, .login_overlay').hide();
    });

    //page price
    $('.img-product-price a').click(function () {
        $('.intro-product').removeAttr("style");
        var boxProductInfo = $(this).data('id');
        $(".box-product-price .support_item").removeAttr("style");
        $(".box-product-price  .col-xs-3").removeAttr("style");
        $('.box-product-price .product-price').removeClass("active");
        var bt = $(this).parent().parent().parent().offset().top + $(this).parent().parent().parent().outerHeight();
        var lt = $(this).parent().parent().parent().position().left;
        var wt = $(this).parent().parent().parent().outerWidth();
        var mtprice = $('.intro-product#' + boxProductInfo).outerHeight() + 30;
        var arl = 0;
        arl = lt + wt / 2;
        $('.box-product-price .intro-product#' + boxProductInfo + ' .after').css('left', arl);
        $('.box-product-price .intro-product#' + boxProductInfo + ' .before').css('left', arl);
        $(this).parent().parent().parent().css("margin-bottom", mtprice);
        $('.intro-product#' + boxProductInfo).show().css("top", bt);
        $('html,body').animate({scrollTop: $(this).parent().parent().offset().top + 60}, 300);
        $(this).parent().parent().addClass("active");
    });
    $('.box-product-price .intro-product .container i.fa-times').click(function () {
        $('.box-product-price .support_item').removeAttr("style");
        $('.intro-product').removeAttr("style");
    });

    //page support 04/04/2017 Bich
    $(".page-support-detail .col-left-support .list h4").click(function () {
        $(this).parents(".list").find("ul").slideToggle("slow");
        $(this).parents(".list").toggleClass('show-list');
    });
    $('.support_catg').click(function () {
        $('.page-support-detail .col-left').show();
    });

    $('.page-support-detail .col-left').click(function (e) {
        //alert(e.target.className);
        if (e.target.className == "col-left-support" || e.target.className == "col-sm-3 col-left") $(this).hide();
    });


    jQuery('.owl-carousel').owlCarousel({
        loop: true,
        responsiveClass: true,
        navigation: true,
        pagination: false,
        itemsCustom: [
            [360, 1],
            [400, 2],
            [600, 3],
            [1000, 4]
        ]
    })
});


function login() {
    $('.login .lgn').toggleClass('active');
    $(".desktop input, .mobile input").keypress(function (event) {
        if (event.which == 13) {
            event.preventDefault();
            var nm = $(".desktop input").val();
            var nmm = $(".mobile input").val();
            if (nm) {
                window.location = "http://" + nm + ".kiotviet.vn/";
            }
            if (nmm) {
                window.location = "http://" + nmm + ".kiotviet.vn/";
            }
        }
    });
    $(".step-login").click(function (event) {
        var nm = $(".desktop input").val();
        var nmm = $(".mobile input").val();
        if (nm) {
            window.location = "http://" + nm + ".kiotviet.vn/";
        }
        if (nmm) {
            window.location = "http://" + nmm + ".kiotviet.vn/";
        }
    });
}


// Todo: FRONTEND POPUP REGISTER 2016
/**
 * Created by tuyenvv on 29/12/2015.
 */
var frontRegister = {
    // Todo : prepare data
    formData: {
        industry: null,
        industry2: null,
        phone: null,
        companyname: null,
        fullname: null,
        username: null,
        password: null,
        passagain: null,
        zone: null,
        lead_source_description: null,
        refered_by: null,
        code: null,
        address: null,
        email: null,
        captcha: null,
        lead_source: null,
        voucher: null
    },
    voucher: function () {
        var xhr = new window.XMLHttpRequest();
        var promotionCodeInp = $("#promotion_code");
        promotionCodeInp.keyup(function () {
            xhr.abort();
            frontRegister.formData.voucher = $("input#promotion_code").val();
            frontRegister.checkVoucher(function(){
            });
        });
    },
    createCookie: function (name, value, days) {
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            var expires = "; expires=" + date.toGMTString();
        }
        else var expires = "";
        document.cookie = name + "=" + value + expires + "; path=/";
    },
    readCookie: function (name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    },
    registerStep: function ($a, $b) {
        $(".register-content").hide();
        $($b).show();
        if ($($a).hasClass('link')) $("span#front-register-error").html("");
        scrollTo(0, 0);

    },
    registertoTop: function () {
        scrollTo(0, 0);

    },
    reloadCaptcha: function () {
        $("a#reload-captcha").on("click", function (e) {
            $("img#captcha-image").attr("src", php_vars.template_uri + "/recaptcha/get_captcha.php?rnd=" + Math.random());
            e.preventDefault();
        });
    },
    storeName: function (v) {
        v = v.toLowerCase();
        v = v.replace(/a|á|à|ả|ã|ạ|ă|ắ|ằ|ẳ|ẵ|ặ|â|ấ|ầ|ẩ|ẫ|ậ/g, "a");
        v = v.replace(/o|ó|ò|ỏ|õ|ọ|ô|ố|ồ|ổ|ỗ|ộ|ơ|ớ|ờ|ở|ỡ|ợ/g, "o");
        v = v.replace(/e|é|è|ẻ|ẽ|ẹ|ê|ế|ề|ể|ễ|ệ/g, "e");
        v = v.replace(/i|í|ì|ỉ|ĩ|ị/g, "i");
        v = v.replace(/u|ú|ù|ủ|ũ|ụ|ư|ứ|ừ|ử|ữ|ự/g, "u");
        v = v.replace(/đ|Đ/g, "d");
        v = v.replace(/y|ý|ỳ|ỷ|ỹ|ỵ/g, "y");
        v = v.replace(/ /g, "");
        v = v.replace(/\`|\~|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\-|\_|\+|\=|\[|\{|\]|\}|\\|\||\;|\:|\'|\"|\,|\<|\.|\>|\/|\?/g, "");
        return v;
    },
    //  Todo: Step 1, select industry
    selectIndustry: function () {
        var selectedIndustry = frontRegister.readCookie('parent');

        if (selectedIndustry != null) {
            //alert(selectedIndustry);
            $("ul.box-list-industry li").each(function () {
                var $this = $(this);
                var industry = $this.attr("data-id");

                if (industry == selectedIndustry) {
                    $this.addClass("selected");
                    frontRegister.formData.industry = industry;
                }
            });
            frontRegister.registerStep('.register-step1', '#register_step2');
        }

        $("ul.box-list-industry li").on("click", function (e) {
            var $this = $(this);
            var industry = $this.attr("data-id");
            frontRegister.formData.industry = industry;
            frontRegister.createCookie("parent", industry, 7);
            $("ul.box-list-industry li").removeClass("selected");
            $this.addClass("selected");
            frontRegister.registerStep('.register-step1', '#register_step2');
            $("span#front-register-error").html("");
            e.preventDefault();
        });

        $("div#register_step1 a.register-step1").on("click", function (e) {
            if (frontRegister.formData.industry == null) {
                $("span#front-register-error").html("Vui lòng chọn nghành hàng của bạn");
                frontRegister.registertoTop();
            } else {
                $("span#front-register-error").html("");
                frontRegister.registerStep('.register-step1', '#register_step2');
            }
            e.preventDefault();
        });
    },
    // Todo: Step 2, Kiot informartion
    kiotInfo: function () {
        var intRegex = /^[+-]?\d+(\.\d+)?([eE][+-]?\d+)?$/;

        $("input#storename").on("change", function () {
            var $this = $(this);
            $("input#code").val(frontRegister.storeName($this.val()));
            $("span.storetxt").text(frontRegister.storeName($this.val()));
        });

        $("input#code").on("change", function () {
            var $this = $(this);
            $("input#code").val(frontRegister.storeName($this.val()));
            $("span.storetxt").text(frontRegister.storeName($this.val()));
        });

        $("input#phone").on("keyup", function () {
            var $this = $(this);
            $("input#name").val($this.val());
        });

        $("div#register_step2 a.register-step2").on("click", function (e) {
            frontRegister.formData.fullname = $("input#fullname").val();
            frontRegister.formData.phone = $("input#phone").val();
            frontRegister.formData.companyname = $("input#storename").val();
            frontRegister.formData.code = $("input#code").val();
            frontRegister.formData.username = $("input#name").val();
            frontRegister.formData.password = $("input#pass").val();
            frontRegister.formData.passagain = $("input#passagain").val();
            var tmpData = frontRegister.formData;
            if (tmpData.phone.length < 6 || tmpData.phone.length > 11 || (!intRegex.test(tmpData.phone))) {
                $("span#front-register-error").html("Số điện thoại không hợp lệ");
                frontRegister.registertoTop();
                return;
            }

            if (tmpData.passagain != tmpData.password) {
                $("span#front-register-error").html("Mật khẩu không trùng khớp");
                frontRegister.registertoTop();
                return;
            }

            if (tmpData.companyname == "" || tmpData.code == "" || tmpData.username == "" || tmpData.password == "" || tmpData.fullname == "") {
                $("span#front-register-error").html("Vui lòng nhập đầy đủ thông tin");
                frontRegister.registertoTop();
                return;
            }

            errorUser = /^[0-9a-zA-Z@._-]+$/;
            if (!errorUser.test(tmpData.username)) {
                $("span#front-register-error").html("Tên đăng nhập chưa hợp lệ. Tên đăng nhập chỉ được bao gồm các kí tự A-Z, a-z, 0-9 và các kí tự như @ . - _");
                frontRegister.registertoTop();
                return;
            }

            errorPass = /^[0-9a-zA-Z`~!@#$%^&*()_+=|\\\]}{\["':;?\/>.<,-]*$/;
            if (!errorPass.test(tmpData.password)) {
                $("span#front-register-error").html("Mật khẩu chưa hợp lệ. Mật khẩu không được chứa dấu cách hoặc tiếng Việt có dấu");
                frontRegister.registertoTop();
                return;
            }


            $("span#front-register-error").html("");
            frontRegister.registerStep('.register-step2', '#register_step3');

            kvUtil.ajaxCountSingle('step1');

            $("select#industry").val(frontRegister.formData.industry);
            $("select#industry option").each(function () {
                var $this = $(this);
                if ($this.attr("value") == frontRegister.formData.industry) {
                    $this.attr("selected", "selected");
                    return;
                }
            });
            e.preventDefault();
        });
    },
    //Todo: Step 3, Addition infomation
    additionInfo: function () {
        shortcut.add("Ctrl+1", function () {
            $("div.hidden-field-form").show();
        });
        shortcut.add("Ctrl+2", function () {
            $("div.hidden-field-form").show();
        });

        var emailRegex = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

        $("div#register_step3 a.register-step3").on("click", function (e) {
            var $this = $(this);

            if ($this.attr("data-submited") == "true") {

                return;
            }

            $("div#register_step3 a.register-step3").attr("data-submited", "true");

            frontRegister.formData.industry = $("select#industry").val();
            frontRegister.formData.zone = $("select#location").val();
            frontRegister.formData.address = $("input#address").val();
            frontRegister.formData.email = $("input#email").val();
            frontRegister.formData.captcha = $("input#captcha").val();
            frontRegister.formData.lead_source_description = $("#id_source_description").val();
            frontRegister.formData.refered_by = $("input#refered_by").val();
            frontRegister.formData.voucher = $("input#promotion_code").val();
            if (frontRegister.formData.zone == "") {
                $("span#front-register-error").html("Vui lòng chọn tỉnh thành của bạn");
                $("div#register_step3 a.register-step3").attr("data-submited", "false");
                frontRegister.registertoTop();
                return;
            }
            if (frontRegister.formData.captcha == "") {
                frontRegister.registertoTop();
                $("span#front-register-error").html(" Vui lòng nhập Mã xác thực");
                $("div#register_step3 a.register-step3").attr("data-submited", "false");
                return;
            }

            if (frontRegister.formData.email.length != 0 && !emailRegex.test(frontRegister.formData.email)) {
                frontRegister.registertoTop();
                $("span#front-register-error").html("Vui lòng nhập đúng định dạng email");
                $("div#register_step3 a.register-step3").attr("data-submited", "false");
                return;
            }
            $("span#front-register-error").html("");
            frontRegister.checkVoucher(function () {
                frontRegister.checkCaptcha(function () {
                    frontRegister.registerKiot(function () {
                        ga('send', 'event', 'Đăng ký');
                        $("span#front-register-error").html("");
                        frontRegister.registerCRM();
                        kvUtil.ajaxCountSingle('success');
                    });
                });
            });
        });
    },
    checkVoucher: function (callback) {
        var errorEl = $("#promotion_code_errow");
        var successEl = $("#promotion_code_success");
        $.ajax({
            type: "POST",
            url: php_vars.ajax_url,
            data: {
                'action': 'add_promotionCode',
                'promotionCode': frontRegister.formData.voucher
            },
            dataType: 'json',
            success: function (data) {
                if (data['code'] == 1 || data['code'] == 3){
                    successEl.text(data['msg']).show();
                    errorEl.hide();
                    callback();
                }else if(data['code'] == 2){
                    errorEl.text(data['msg']).show();
                    successEl.hide();
                }
                else if(data['code'] == 4){
                    errorEl.text(data['msg']).show();
                    successEl.hide();
                }
                else{
                    errorEl.text(data['msg']).show();
                    successEl.hide();
                }
                frontRegister.registertoTop();
                $("div#register_step3 a.register-step3").attr("data-submited", "false");
            },
            error: function (erro) {
                kvUtil.writeLog("Error");
                kvUtil.writeLog(erro);
            }
        });
    },
    checkCaptcha: function (callback) {
        $.ajax({
            url: php_vars.template_uri + "/recaptcha/checkCaptcha.php",
            type: "POST",
            async: false,
            dataType: "text",
            data: {
                'captcha_code': frontRegister.formData.captcha,
                'code': frontRegister.formData.code
            },
            success: function (resp) {
                if (resp == 0) {
                    callback();
                } else {
                    $("img#captcha-image").attr("src", php_vars.template_uri + "/recaptcha/get_captcha.php?rnd=" + Math.random());
                    frontRegister.registertoTop();
                    $("span#front-register-error").html("Sai mã xác nhận, vui lòng nhập lại");
                    $("div#register_step3 a.register-step3").attr("data-submited", "false");
                }
            },
            error: function (erro) {
                kvUtil.writeLog("Error");
                kvUtil.writeLog(erro);
            }
        });
    },
    registerKiot: function (callback) {
        //Convert for app
        var indust = frontRegister.formData.industry;
        switch (parseInt(indust)) {
            //Thời trang
            case 77:
                frontRegister.formData.industry2 = 10;
                break;
            //Mẹ và bé
            case 19:
                frontRegister.formData.industry2 = 1;
                break;
            //Mỹ phẩm
            case 15:
                frontRegister.formData.industry2 = 2;
                break;
            //Siêu thị mini
            case 63:
                frontRegister.formData.industry2 = 9;
                break;
            //Điện tử điện máy
            case 65:
                frontRegister.formData.industry2 = 7;
                break;
            //Hoa & quà tặng
            case 75:
                frontRegister.formData.industry2 = 3;
                break;
            //Tạp hóa
            case 61:
                frontRegister.formData.industry2 = 9;
                break;
            //Nội thất & gia dụng
            case 73:
                frontRegister.formData.industry2 = 4;
                break;
            //Xe, máy & linh kiện
            case 67:
                frontRegister.formData.industry2 = 8;
                break;
            //Sách & văn phòng phẩm
            case 69:
                frontRegister.formData.industry2 = 6;
                break;
            //Vật liệu xây dựng
            case 71:
                frontRegister.formData.industry2 = 5;
                break;
            //Nông sản & thực phẩm
            case 9:
                frontRegister.formData.industry2 = 11;
                break;
            //Nhà thuốc
            case 3472:
                frontRegister.formData.industry2 = 12;
                break;
            //Bar - cafe - nhà hàng
            case 3949:
                frontRegister.formData.industry2 = 15;
                break;
            //Other
            case 1984:
                frontRegister.formData.industry2 = 0;
                break;
        }

        $.ajax({
            type: "POST",
            url: php_vars.site_uri + "/kiotviet.php",
            data: {
                demo: {
                    'type': 0,
                    'fullname': frontRegister.formData.fullname,
                    'email': frontRegister.formData.email,
                    'phone': frontRegister.formData.phone,
                    'companyname': frontRegister.formData.companyname,
                    'captcha_code': frontRegister.formData.captcha,
                    'code': frontRegister.formData.code,
                    'username': frontRegister.formData.username,
                    'password': frontRegister.formData.password,
                    'zone': frontRegister.formData.zone,
                    'industry': frontRegister.formData.industry2,
                    'lead_source': frontRegister.formData.id_source,
                    'lead_source_description': frontRegister.formData.lead_source_description,
                    'refered_by': frontRegister.formData.refered_by,
                    'address': frontRegister.formData.address,
                    'voucher': frontRegister.formData.voucher
                }
            },
            dataType: "json",
            beforeSend: function () {
                kvUtil.writeLog("Register sending....");
            },
            success: function (resp) {
                if (resp.code == 1) {
                    if (kvUtil.clickOnIndustry) {
                        kvUtil.ajaxCount(4); // an nut ket thuc co click + hiện thị số lần kết thúc form đăng ký
                    } else {
                        kvUtil.ajaxCount(7);//hiển thị số lần an nut ket thuc khong click chọn ngành hàng
                    }
                    //frontRegister.registerStep('.register-step3', '#register_step4')
                    var shop_url = "https://" + frontRegister.formData.code + "." + php_vars.KVURL;
                    var shop_short_url = "https://" + frontRegister.formData.code + "." + php_vars.KVURL;
                    $("button.register-step4").on("click", function () {
                        window.location.href = shop_url;
                    });

                    $("h5#store-name").html(frontRegister.formData.companyname);
                    $("h5#store-url").html('<a href="' + shop_short_url + '">' + frontRegister.formData.code + "." + php_vars.KVURL + '</a>');
                    $("h5#store-user").html(frontRegister.formData.username);
                    var imgAccessTrade = '<img src="https://cv.accesstrade.vn/cv.php?identifier=' + frontRegister.formData.username + '&mcn=a97da629b098b75c294dffdc3e463904&result_id=502" width="1" height="1" />';
                    $("body").append(imgAccessTrade);
                    callback();
                } else {
                    $("span#front-register-error").html(resp.msg);
                    $("div#register_step3 a.register-step3").attr("data-submited", "false");
                }
            },
            error: function (error) {
                kvUtil.writeLog(error);
            }
        });
    },


    registerCRM: function () {
        $.ajax({
            type: "POST",
            url: php_vars.site_uri + "/dang-ky-popup/",
            dataType: "json",
            data: {
                request: {
                    'type': 0,
                    'fullname': frontRegister.formData.fullname,
                    'email': frontRegister.formData.email,
                    'phone': frontRegister.formData.phone,
                    'companyname': frontRegister.formData.companyname,
                    'captcha_code': frontRegister.formData.captcha,
                    'code': frontRegister.formData.code,
                    'username': frontRegister.formData.username,
                    'password': frontRegister.formData.password,
                    'zone': frontRegister.formData.zone,
                    'industry': frontRegister.formData.industry,
                    'lead_source': frontRegister.formData.lead_source,
                    'lead_source_description': frontRegister.formData.lead_source_description,
                    'refered_by': frontRegister.formData.refered_by,
                    'address': frontRegister.formData.address,
                    'voucher': frontRegister.formData.voucher

                }
            },
            success: function (resp) {
                kvUtil.writeLog(resp);
                window.location.href = "/dang-ky-thanh-cong"
            },
            dataType: "json"
        });
    },
    init: function () {
        frontRegister.selectIndustry();
        frontRegister.kiotInfo();
        frontRegister.additionInfo();
        frontRegister.reloadCaptcha();
        frontRegister.voucher();
    }

};
var kvUtil = {
    clickOnIndustry: false,
    isDebug: false,
    catId: null,
    tagId: null,
    fbShare: function (url, winWidth, winHeight) {
        var winTop = (screen.height / 2) - (winHeight / 2);
        var winLeft = (screen.width / 2) - (winWidth / 2);
        window.open('https://www.facebook.com/sharer/sharer.php?u=' + url, 'sharer', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,width=' + winWidth + ',height=' + winHeight);
    },
    gpShare: function (url, winWidth, winHeight) {
        var winTop = (screen.height / 2) - (winHeight / 2);
        var winLeft = (screen.width / 2) - (winWidth / 2);
        window.open('https://plus.google.com/share?url=' + url, 'sharer', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,width=' + winWidth + ',height=' + winHeight);
    },
    jsResize: function () {
        var $main_images = $('img.js-resize');
        //$i = 0;
        $main_images.each(function () {
            var $pdivw = $(this).parents('.wrap-img-kh').width(),
                $pdivh = $(this).parents('.wrap-img-kh').height();
            //Bind new images get natural width and height
            img = new Image();
            img.src = $(this).attr('src');
            $nwimage = img.naturalWidth;
            $nhimage = img.naturalHeight;

            $(this).removeAttr('style');

            if ($nwimage / $nhimage > $pdivw / $pdivh) {
                $(this).css({'max-height': '100%', 'max-width': 'none'});
                if ($nhimage < $pdivh) {
                    $(this).css('height', $pdivh);
                }
            } else {
                $(this).css('max-width', '100%');
                if ($nwimage < $pdivw) {
                    $(this).css('width', $pdivw);
                }
            }
        });
    },
    facebookSdk: function () {
        $.getScript('//connect.facebook.net/en_US/all.js', function () {
            FB.init({
                appId: '1630263617258818',
                version: 'v2.9'
            });

            FB.Event.subscribe('comment.create', function (response) {
                var comment_href = response.href;
                var comment_ID = response.commentID;
                var comment_content = response.message;
                $.ajax({
                    type: "POST",
                    url: php_vars.ajax_url,
                    data: {
                        'action': 'add_fb_comment',
                        'commentHref': comment_href,
                        'commentID': comment_ID,
                        'commentContent': comment_content,
                        'postID': post_id
                    },
                    success: function (resp) {
                        kvUtil.writeLog(resp)
                    }
                })
            });
        })
    },
    toAscii: function (str) {
        str = str.toLowerCase();
        str = str.replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, 'a');
        str = str.replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, 'e');
        str = str.replace(/ì|í|ị|ỉ|ĩ/g, 'i');
        str = str.replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, 'o');
        str = str.replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, 'u');
        str = str.replace(/ỳ|ý|ỵ|ỷ|ỹ/g, 'y');
        str = str.replace(/đ/g, 'd');
        str = str.replace(/\W+/g, ' ');
        str = str.replace(/\s/g, ' ');
        return str;
    },
    ajaxCount: function (type) {
        $.ajax({
            type: "POST",
            url: php_vars.ajax_url,
            data: {
                'action': 'add_count_views',
                'countType': type
            },
            success: function (resp0) {
                kvUtil.writeLog(resp0)
            }
        })
    },
    ajaxCountSingle: function (type) {
        var checkCallToAction = $('body').attr('call-to-action');
        if (checkCallToAction != 'true') {
            return;
        }
        $.ajax({
            type: "POST",
            url: php_vars.ajax_url,
            data: {
                'action': 'add_count_views_single',
                'type': type,
                'catId': kvUtil.catId,
                'tagId': kvUtil.tagId
            },
            dataType: 'json',
            success: function (resp) {
                kvUtil.writeLog(resp);
            }
        })
    },
    writeLog: function (msg) {
        if (kvUtil.isDebug) {
            kvUtil.writeLog(msg);
        }
    },
    countViews: function () {

        $("#show_signup").click(function () {
            kvUtil.ajaxCount(0);//đếm số lần click vào nút đăng ký
            var query = $('#register_step2');
            var isVisible = query.is(':visible');
            if (isVisible === true) {
                kvUtil.ajaxCount(5); //số lần hiển thị form 1 không có chọn ngành hàng
            }
        });
        $("#register_step1").click(function () {
            kvUtil.clickOnIndustry = true;
            kvUtil.ajaxCount(2); // đếm số lần hiển thị form 1
            kvUtil.ajaxCount(1); // hiện thị số lần chon nganh hang
        });
        $("#register_step2 .register-btn.pull-right.register-step2").click(function () {
            if (kvUtil.clickOnIndustry) {
                kvUtil.ajaxCount(3); // hiện thị số lần form 2
            } else {
                kvUtil.ajaxCount(6);//hien thị số lần form 2 khong co click
            }
        });
        $(".register-back-step3").click(function () {
            if (kvUtil.clickOnIndustry) {
                kvUtil.ajaxCount(2); // hiện thị số lần form 2
            } else {
                kvUtil.ajaxCount(5);//hien thị số lần form 2 khong co click
            }
        });
        $("#box-register-single").click(function () {
            $('body').attr('call-to-action', 'true');
            var $this = $(this);
            if ($this.attr('click-call-to-action') == 'true') {
                return;
            }
            $this.attr('click-call-to-action', 'true');

            kvUtil.catId = $("#array_value_cat").val();
            kvUtil.tagId = $("#array_value_tags").val();
            kvUtil.ajaxCountSingle('calltoaction');
        });
    },
    init: function () {
        kvUtil.jsResize();
        kvUtil.facebookSdk();
        kvUtil.countViews();
    }
};
$(document).ready(function () {
    frontRegister.init();
    kvUtil.init();
});